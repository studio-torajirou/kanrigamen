<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>スタジオ寅次郎 予約管理</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="loading-spinner"></div>
  </div>

  <div id="toast" class="toast"></div>

  <div id="customAlertModal" class="modal" style="display:none; z-index:10000;" role="dialog" aria-modal="true">
    <div class="modal-card modal-card--alert">
      <div class="modal-bd" style="text-align:center; padding: 24px;">
        <p id="customAlertMessage" style="font-size:24px; font-weight:bold; color:var(--ink); margin:0 0 24px; white-space: pre-wrap; line-height:1.5;"></p>
        <button class="btn" type="button" onclick="document.getElementById('customAlertModal').style.display='none'" style="min-width: 160px;">OK</button>
      </div>
    </div>
  </div>

  <div id="authModal" class="modal" style="display:flex;">
    <div class="modal-card" style="max-width:350px;">
      <div class="modal-hd" style="justify-content:center; border-bottom:none; padding-bottom:0;">
        <strong>管理者認証</strong>
      </div>
      <div class="modal-bd">
        <p style="text-align:center; margin-bottom:15px; color:var(--ink-muted); font-size:20px;">パスワードを入力してください</p>
        <input type="tel" id="adminPassInput" class="field" style="width:100%; padding:16px; font-size:32px; text-align:center; letter-spacing:4px; border-radius:16px; border:2px solid var(--line);" placeholder="••••">
        <p id="authError">パスワードが違います</p>
      </div>
      <div class="modal-ft" style="justify-content:center; padding-top:0; border-top:none; background:transparent;">
        <button id="btnAdminLogin" class="btn" type="button" style="width:100%;">ログイン</button>
      </div>
    </div>
  </div>

  <header class="hd">
    <div class="hd-inner">
      <div class="hd-title-block">
        <h1 class="hd-title">スタジオ寅次郎 予約管理</h1>
        <p class="hd-subtitle">スケジュール登録・顧客管理</p>
      </div>
      <div class="hd-actions">
        <button id="btnHelp" class="btn-outline" type="button">使い方</button>
      </div>
    </div>
  </header>

  <main class="main">
    <section class="card">
      <div class="card-hd">
        <div class="card-title-block">
          <p class="card-subtitle">日付をタップしてレッスンを登録します</p>
        </div>
        <div class="card-actions">
          <button id="monthPrev" class="btn-outline" type="button">◀</button>
          <span id="monthLabel" class="month-label">----/--</span>
          <button id="monthNext" class="btn-outline" type="button">▶</button>
        </div>
      </div>
      
      <div class="card-bd calendar-wrapper">
        <div class="cal-grid" id="calendarGrid"></div>
      </div>

      <div class="card-ft day-panel">
        <div class="day-panel-hd">
          <div>
            <p class="day-label-caption">選択中の日付</p>
            <p id="selectedDateLabel" class="day-label-main">-</p>
          </div>
          <div class="day-panel-actions">
            <button id="btnAddSlot" class="btn" type="button">この日にレッスンを追加</button>
          </div>
        </div>
        <div id="slotList" class="slot-list"></div>
      </div>
    </section>

    <section class="card">
      <div class="card-hd">
        <div class="card-title-block">
          <h2 class="card-title">レッスンパッケージ</h2>
          <p class="card-subtitle">レッスンの雛形（テンプレート）を管理</p>
        </div>
        <div class="card-actions">
          <button id="btnNewPackage" class="btn" type="button">＋ 新規登録</button>
        </div>
      </div>
      <div class="card-bd">
        <div id="packageList" class="package-list"></div>
      </div>
    </section>

    <div class="grid grid-2">
      <section class="card" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between;" onclick="adminOpenCustomerList()">
        <div>
          <h2 class="card-title">顧客台帳</h2>
          <p class="card-subtitle">顧客情報・履歴の確認</p>
        </div>
        <span style="font-size:40px;">👥</span>
      </section>

      <section class="card" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between;" onclick="adminOpenSettings()">
        <div>
          <h2 class="card-title">スタジオ設定</h2>
          <p class="card-subtitle">住所や紹介文の編集</p>
        </div>
        <span style="font-size:40px;">⚙️</span>
      </section>
    </div>
  </main>

  <footer class="ft">
    <small>© スタジオ寅次郎予約システム</small>
  </footer>

  <div id="helpModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-card modal-card--lg">
      <div class="modal-hd">
        <strong class="help-title">操作マニュアル</strong>
        <button class="modal-close" type="button" onclick="document.getElementById('helpModal').style.display='none'">×</button>
      </div>
      <div class="modal-bd help-content">
        <div style="margin-bottom: 10px;">
          <h4 style="margin-bottom: 8px; color: var(--ink); border-bottom: 1px dashed var(--line); padding-bottom: 4px;">1. スケジュールの作り方</h4>
          <p style="font-size: 15px; line-height: 1.6; margin-bottom: 20px; color: var(--ink);">
            ① 画面下部の「レッスンパッケージ」の<strong>「＋ 新規登録」</strong>から、レッスンの雛形（基本情報）を作ります。<br>
            ② カレンダーの追加したい<strong>日付をタップ</strong>します。<br>
            ③ <strong>「この日にレッスンを追加」</strong>を押し、作ったパッケージを選んで時間を設定して保存します。
          </p>

          <h4 style="margin-bottom: 8px; color: var(--ink); border-bottom: 1px dashed var(--line); padding-bottom: 4px;">2. 予約の確認・キャンセル処理</h4>
          <p style="font-size: 15px; line-height: 1.6; margin-bottom: 20px; color: var(--ink);">
            カレンダーのレッスン枠をタップすると、予約したお客様の一覧を確認できます。<br>
            やむを得ない場合はここから<strong>「強制キャンセル」</strong>が可能です。<br>
            <span style="font-size:13px; color:#ef5350;">※実行するとお客様に通知メールが送られ、キャンセル待ちがいる場合は自動で繰り上げられます。</span>
          </p>

          <h4 style="margin-bottom: 8px; color: var(--ink); border-bottom: 1px dashed var(--line); padding-bottom: 4px;">3. その他の機能</h4>
          <ul style="font-size: 15px; line-height: 1.6; padding-left: 20px; margin-bottom: 10px; color: var(--ink);">
            <li style="margin-bottom: 6px;"><strong>顧客台帳：</strong>お客様の連絡先や来店回数、予約履歴を検索・確認できます。</li>
            <li><strong>スタジオ設定：</strong>お客様の予約画面に表示される紹介文やメールアドレスを変更できます。</li>
          </ul>
        </div>
      </div>
      <div class="modal-ft">
        <button class="btn" type="button" onclick="document.getElementById('helpModal').style.display='none'">閉じる</button>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-card modal-card--lg">
      <div class="modal-hd">
        <strong>スタジオ情報の編集</strong>
        <button class="modal-close" type="button" onclick="adminCloseSettings()">×</button>
      </div>
      <div class="modal-bd">
        <p class="subtle-text" style="color:var(--ink-muted); margin-bottom:16px;">ユーザー画面の「About Studio」等に表示される内容です。</p>
        <label class="field"><span>スタジオ名</span><input id="setStudioName" type="text" placeholder="Studio Torajiro"></label>
        <label class="field"><span>Concept (紹介文)</span><textarea id="setConcept" rows="6" placeholder="スタジオの魅力やコンセプト..."></textarea></label>
        <label class="field"><span>住所</span><input id="setAddress" type="text" placeholder="東京都..."></label>
        <label class="field"><span>お問い合わせメール</span><input id="setContactEmail" type="email" placeholder="info@example.com"></label>
        <label class="field"><span>設備・サービス</span><input id="setFacilities" type="text" placeholder="マット無料など"></label>
      </div>
      <div class="modal-ft">
        <button id="btnSaveSettings" class="btn" type="button" onclick="adminSaveSettings()">保存して反映</button>
      </div>
    </div>
  </div>

  <div id="customerListModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-card modal-card--lg">
      <div class="modal-hd">
        <strong>顧客台帳</strong>
        <button class="modal-close" type="button" onclick="adminCloseCustomerList()">×</button>
      </div>
      <div class="modal-bd">
        <div style="margin-bottom:24px;">
          <input id="customerSearchInput" type="text" class="field" style="margin-bottom:0;" placeholder="名前や電話番号で検索...">
        </div>
        <p id="customerListMsg" class="empty-text" style="display:none;">データなし</p>
        <ul id="customerListUL" class="guest-list"></ul>
      </div>
      <div class="modal-ft">
        <button class="btn" type="button" onclick="adminCloseCustomerList()">閉じる</button>
      </div>
    </div>
  </div>

  <div id="customerHistoryModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-card modal-card--lg">
      <div class="modal-hd">
        <strong>予約履歴</strong>
        <button class="modal-close" type="button" onclick="adminCloseCustomerHistory()">×</button>
      </div>
      <div class="modal-bd">
        <p id="historyCustomerName" style="border-bottom:1px dashed var(--line); padding-bottom:12px; margin-bottom:16px; font-size:24px; color:var(--ink);">- 様</p>
        <ul id="customerHistoryUL" class="guest-list"></ul>
      </div>
      <div class="modal-ft">
        <button class="btn" type="button" onclick="adminCloseCustomerHistory()">閉じる</button>
      </div>
    </div>
  </div>

  <div id="packageModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-hd">
        <strong id="packageModalTitle">パッケージ登録</strong>
        <button class="modal-close" type="button" onclick="adminClosePackageModal()">×</button>
      </div>
      <div class="modal-bd">
        <input type="hidden" id="packageId">
        <label class="field"><span>レッスン名 (必須)</span><input id="packageLessonName" type="text"></label>
        <label class="field"><span>先生名</span><input id="packageTeacherName" type="text"></label>
        <label class="field"><span>レッスン内容</span><textarea id="packageDescription" rows="5"></textarea></label>
        <div class="grid grid-2">
          <label class="field"><span>料金 (円)</span><input id="packagePrice" type="number"></label>
          <label class="field"><span>定員 (名)</span><input id="packageCapacity" type="number"></label>
        </div>
        <div class="field">
          <label style="display:flex; align-items:center; cursor:pointer;">
            <input id="packageIsPublic" type="checkbox" style="width:24px; height:24px; margin-right:12px;" checked>
            <span style="font-weight:bold; font-size:16px;">ユーザー画面に「表示」する</span>
          </label>
        </div>
        <label class="field">
          <span>カラー (チェックマークで選択)</span>
          <input id="packageColor" type="hidden">
          <div id="packageColorPalette" class="color-palette"></div>
        </label>
      </div>
      <div class="modal-ft" style="justify-content:space-between;">
        <button id="packageDeleteBtn" class="btn-danger" type="button" style="display:none;">削除</button>
        <div style="display:flex; gap:12px; margin-left:auto;">
          <button class="btn-outline" type="button" onclick="adminClosePackageModal()">キャンセル</button>
          <button id="packageSaveBtn" class="btn" type="button">保存</button>
        </div>
      </div>
    </div>
  </div>

  <div id="packageDeleteModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-card modal-card--alert">
      <div class="modal-hd"><strong>削除確認</strong></div>
      <div class="modal-bd"><p style="font-size:24px;">このパッケージを削除しますか？<br>※作成済みの予約枠は消えません。</p></div>
      <div class="modal-ft">
        <button class="btn-outline" type="button" onclick="adminClosePackageDeleteModal()">キャンセル</button>
        <button id="packageDeleteConfirmBtn" class="btn-danger" type="button">削除する</button>
      </div>
    </div>
  </div>

  <div id="packageSelectModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-card modal-card--lg">
      <div class="modal-hd">
        <strong>パッケージを選択</strong>
        <button class="modal-close" type="button" onclick="adminClosePackageSelectModal()">×</button>
      </div>
      <div class="modal-bd">
        <p style="font-size:24px; color:var(--ink-muted); margin-bottom:16px;">追加するレッスンの雛形を選んでください</p>
        <div id="packageSelectList" class="package-list"></div>
      </div>
      <div class="modal-ft">
        <button class="btn-outline" type="button" onclick="adminClosePackageSelectModal()">閉じる</button>
      </div>
    </div>
  </div>

  <div id="slotModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-hd">
        <strong id="slotModalTitle">レッスン枠編集</strong>
        <button class="modal-close" type="button" onclick="adminCloseSlotModal()">×</button>
      </div>
      <div class="modal-bd">
        <input type="hidden" id="slotId">
        <div id="slotPackageArea" class="package-summary" style="display:none;"></div>
        <label id="slotManualInputArea" class="field" style="display:none;">
          <span>レッスン名</span>
          <input id="slotManualName" type="text">
        </label>
        <label id="slotManualTeacherArea" class="field" style="display:none;">
          <span>先生名</span>
          <input id="slotManualTeacher" type="text">
        </label>

        <p id="slotDateLabel" style="font-size:28px; font-weight:bold; color:var(--accent-deep); margin-bottom:24px;"></p>
        
        <div class="grid grid-2">
          <label class="field"><span>開始</span><input id="slotStartTime" type="time"></label>
          <label class="field"><span>終了</span><input id="slotEndTime" type="time"></label>
        </div>
        
        <div class="grid grid-2">
          <label class="field">
            <span>料金</span>
            <input id="slotPrice" type="number">
            <span id="priceLockMsg">※予約有のため変更不可</span>
          </label>
          <label class="field"><span>定員</span><input id="slotCapacity" type="number"></label>
        </div>

        <div class="field">
          <label style="display:flex; align-items:center; cursor:pointer;">
            <input id="slotIsPublic" type="checkbox" style="width:24px; height:24px; margin-right:12px;" checked>
            <span style="font-weight:bold; font-size:16px;">ユーザー画面に「表示」する</span>
          </label>
        </div>

        <label class="field">
          <span>カレンダー色</span>
          <input id="slotColor" type="hidden">
          <div id="slotColorPalette" class="color-palette"></div>
        </label>

        <div id="slotGuestSection">
          <p style="font-size:24px; font-weight:bold; margin-bottom:12px;">予約済みのお客様</p>
          <ul id="slotGuestList" class="guest-list">
            </ul>
        </div>
      </div>

      <div class="modal-ft" style="justify-content:space-between;">
        <button id="slotDeleteBtn" class="btn-danger" type="button" style="display:none;">削除</button>
        <div style="display:flex; gap:12px; margin-left:auto;">
          <button class="btn-outline" type="button" onclick="adminCloseSlotModal()">キャンセル</button>
          <button id="slotSaveBtn" class="btn" type="button">保存</button>
        </div>
      </div>
    </div>
  </div>

  <div id="slotDeleteModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-card modal-card--alert">
      <div class="modal-hd"><strong>削除確認</strong></div>
      <div class="modal-bd"><p id="slotDeleteConfirmMessage" style="font-size:24px;">このレッスン枠を削除しますか？</p></div>
      <div class="modal-ft">
        <button class="btn-outline" type="button" onclick="adminCloseSlotDeleteModal()">キャンセル</button>
        <button id="slotDeleteConfirmBtn" class="btn-danger" type="button">削除する</button>
      </div>
    </div>
  </div>

  <div id="guestDetailModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-hd">
        <strong>お客様詳細</strong>
        <button class="modal-close" type="button" onclick="adminCloseGuestDetailModal()">×</button>
      </div>
      <div class="modal-bd">
        <label class="field"><span>お名前</span><input id="guestName" type="text" readonly disabled></label>
        <label class="field"><span>電話番号</span><input id="guestPhone" type="text" readonly disabled></label>
        <label class="field"><span>Email (クリックで送信)</span><input id="guestEmail" type="text" readonly style="cursor:pointer; color:#0056b3; text-decoration:underline;"></label>
        <div class="grid grid-2">
           <label class="field"><span>来店回数</span><input id="guestVisitCount" type="text" readonly disabled></label>
           <label class="field"><span>顧客ID</span><input id="guestCustomerId" type="text" readonly disabled></label>
        </div>
        <label class="field"><span>メモ</span><textarea id="guestMemo" rows="3" readonly disabled></textarea></label>
        <div style="margin-top:24px; text-align:center;">
           <button id="btnGuestHistoryFromDetail" class="btn-outline" type="button" style="width:100%;">過去の履歴を見る</button>
        </div>
      </div>
      <div class="modal-ft">
        <button class="btn" type="button" onclick="adminCloseGuestDetailModal()">閉じる</button>
      </div>
    </div>
  </div>

  <div id="forceCancelModal" class="modal" style="display:none;" role="dialog" aria-modal="true">
    <div class="modal-card modal-card--alert" style="border-top: 6px solid #ef5350;">
      <div class="modal-hd">
        <h3 style="margin:0; color:#ef5350; font-size:24px;">⚠ 強制キャンセル確認</h3>
      </div>
      <div class="modal-bd">
        <p id="forceCancelMessage" class="force-cancel-msg"></p>
        <div class="force-cancel-note">
          ※お客様へ「管理者都合キャンセル」等のメールが自動送信されます。<br>
          ※空きが出た場合、キャンセル待ちの繰り上げが行われます。<br>
          <strong>この操作は取り消せません。</strong>
        </div>
      </div>
      <div class="modal-ft">
        <button class="btn-outline" type="button" onclick="document.getElementById('forceCancelModal').style.display='none'">閉じる</button>
        <button id="btnExecForceCancel" class="btn" type="button" style="background:#ef5350; color:#fff; border:none;">実行する</button>
      </div>
    </div>
  </div>

  <script src="api.js"></script>
  <script src="app.js"></script>

</body>
</html>